%% -*- mode: erlang -*-
%% ex: ft=erlang

{sys, [

    {lib_dirs, ["../deps", "../apps"]},

    {erts, [{mod_cond, derived}, {app_file, strip}]},
    {app_file, strip},

    %NOTE: We always use a release version of 1, we never upgrade releases the erlang way.
    {rel, "mira_bdb_port_driver", "1", [
        mira_bdb_port_driver
    ]},

    {rel, "start_clean", "", [
            kernel
        ,   stdlib
    ]},

    {boot_rel, "mira_bdb_port_driver"},
    {profile, embedded},
    {incl_cond, exclude},

    %% Do not archive built libs - breaks platform_tools (specifically pt_util_sha2.so)
    {excl_archive_filters, [".*"]}, 

    {excl_sys_filters, ["^bin/.*", "^erts.*/bin/(dialyzer|typer)"]},

    %Look at miranode.template_vars.example for how to add your custom entries 
    %here. You then need to pass the path to your file to rebar in the 
    %templat_vars %parameter like so: 
    %           template_vars=path_to_my_template_vars

    %Custom reltool.config app includes start
    
    {app, sasl,                     [{incl_cond, include}]},
    {app, stdlib,                   [{incl_cond, include}]},
    {app, kernel,                   [{incl_cond, include}]},
    {app, mnesia,                   [{incl_cond, include}]},
    {app, crypto,                   [{incl_cond, include}]},
    {app, odbc,                     [{incl_cond, include}]},
    {app, public_key,               [{incl_cond, include}]},
    {app, ssl,                      [{incl_cond, include}]},
    {app, inets,                    [{incl_cond, include}]},
    {app, xmerl,                    [{incl_cond, include}]},
    {app, syntax_tools,             [{incl_cond, include}]},
    {app, compiler,                 [{incl_cond, include}]},
    {app, asn1,                     [{incl_cond, include}]},
    {app, mochiweb,                 [{incl_cond, include}]},
    {app, estatsd,                  [{incl_cond, include}]},
    {app, mira_evmc,                [{incl_cond, include}]},
    {app, mira_platform_tools,      [{incl_cond, include}]},
    {app, mira_uuid_server,         [{incl_cond, include}]},
    {app, mira_eroq,                [{incl_cond, include}]},
    {app, mira_snmp_mibs,           [{incl_cond, include}]},
    {app, mira_snmp_api_tools,      [{incl_cond, include}]},
    {app, mira_snmp_api_client_app, [{incl_cond, include}]},
    {app, mira_cfg_client_api,      [{incl_cond, include}]},
    {app, mira_cfg_generic_object,  [{incl_cond, include}]},
    
    %Custom reltool.config app includes end

    {app, mira_bdb_port_driver, [{incl_cond, include}]}

]}.

{target_dir, "mira_bdb_port_driver"}.

{overlay, [

    {mkdir, "log/sasl"},
    {mkdir, "priv/ssl"},
    {mkdir, "os_scripts"},
    {mkdir, "monitoring"},
    {mkdir, "reports"},
    {mkdir, "config"},
    {mkdir, "etc"},

    {copy, "files/ssl",                "priv"},
    {copy, "files/os_scripts",         "."},
    {copy, "files/monitoring",         "."},
    {copy, "files/reports",            "."},
    {copy, "files/config",             "."},

    {copy, "files/erl",                "\{\{erts_vsn\}\}/bin/erl"},
    {copy, "files/nodetool",           "\{\{erts_vsn\}\}/bin/nodetool"},
    {copy, "files/mira_bdb_port_driver",         "bin/mira_bdb_port_driver"},
    
    % This stuff relates to cuttlefish; the bridge between 
    % /etc/default/mira-core-bdb-driver.conf and the erlang VM
    {template, "schemas/00-mira_bdb_port_driver.schema",   "lib/00-mira_bdb_port_driver.schema"},
    {template, "schemas/98-mnesia.schema",       "lib/98-mnesia.schema"},
    {template, "schemas/99-erlang_vm.schema",    "lib/99-erlang_vm.schema"},
    {copy,     "../deps/cuttlefish/cuttlefish",  "bin/cuttlefish"},

    % This is an erlang app.config file containing hairy stuff that 
    % sysadmins should not have to deal with when deploying the app. It
    % will contain all of the knobs-and-dails that you do not want to 
    % expose in /etc/default/mira-core-bdb-driver.conf
    {copy,     "files/config/advanced.config",   "etc/advanced.config"}


]}.

